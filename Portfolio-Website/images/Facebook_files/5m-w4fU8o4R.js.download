;/*FB_PKG_DELIM*/

__d("CometUnconnectedGamesOptedOutDialogQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="6992644354165796"}),null);
__d("MAWEBDataSource",["I64","MAWEBFetch","MAWSecureDataSource","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){function a(){}var e=a.prototype;e.fetchSecureMessagesProtocol=function(a,c,d,e,f,g){return(i||(i=b("Promise"))).reject("MAWEBDataSource does not support fetchSecureMessagesProtocol yet")};e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i,j,k){if(i==="after")return;i;i=(k=j)!=null?k:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES;j=(yield c("MAWEBFetch")({chatId:b,chatJid:e,count:i,db:a,direction:"before",timestampMs:f}));if(j.success===!1)return;return{hasMoreAfter:!1,hasMoreBefore:!1,msgs:j.value.messages.map(function(a){var b;return{externalId:a.xOfflineThreadingId,msgType:String((b=a.xContentType)!=null?b:"unknown_eb_msg_type"),sortOrderMs:a.sortOrderMs}}).reverse().filter(function(a){return f==null||!(h||(h=d("I64"))).equal(f,(h||(h=d("I64"))).of_float(a.sortOrderMs))||a.externalId!==g})}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();return a}();g["default"]=a}),98);
__d("MAWMessageIntegrityChecker",[],(function(a,b,c,d,e,f){"use strict";function g(a,b){if(a.externalId===b.externalId)return 0;if(a.sortOrderMs>b.sortOrderMs)return 1;return a.sortOrderMs<b.sortOrderMs?-1:-1}function a(a,b,c){var d=0,e=0,f=0,h=0,i=[];while(d<a.length&&e<b.length){var j=a[d],k=b[e],l=g(j,k);l===0?(d+=1,e+=1,i.push([j,"consistent"])):l<0?(e+=1,f+=1,i.push([k,"missing_in_target"])):(d+=1,h+=1,i.push([j,"missing_in_reference"]))}while(b.length!==c&&d<a.length){l=a[d];d+=1;h+=1;i.push([l,"missing_in_reference"])}while(a.length!==c&&e<b.length){k=b[e];e+=1;f+=1;i.push([k,"missing_in_target"])}if(f===0&&h===0)return{detailedResults:i,result:"consistent"};else if(f>0&&h===0)return{detailedResults:i,numOfMissingMessages:f,result:"missing_in_target"};else if(f===0&&h>0)return{detailedResults:i,numOfMissingMessages:h,result:"missing_in_reference"};else return{detailedResults:i,numOfMissingMessages:h+f,result:"missing_in_both"}}f.checkIntegrityforMessageList=a}),66);
__d("MAWMessageIntegrityCheck",["CometDebounce","I64","MAWBridgeSendAndReceive","MAWDbMsg","MAWEBDataSource","MAWMessageIntegrityChecker","MAWMiActOnActThreadReady","MAWSecureLocalDBDataSource","Promise","ReQL","WATagsLogger","asyncToGeneratorRuntime","gkx","logMessengerWebFalcoEvent","promiseDone","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing message detected for ",", result: ",", num of messages missing: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against EB data: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against backend data: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: EB result not available"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["run Message Integrity Check - threadKey: ",", lastItem: ",", pageSize: ",""]);n=function(){return a};return a}var o="3",p=d("WATagsLogger").TAGS(["MissingMessages"]),q=new(c("MAWSecureLocalDBDataSource"))(),r=new(c("MAWEBDataSource"))(),s=c("CometDebounce")(c("logMessengerWebFalcoEvent"));function t(a,b,c,d,e){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){b=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"MAWFetchMessagesFromBackend"));var g=b.chatId;b=b.chatJid;a=(yield q.requestMessages(a,g,b,c!=null?c.primarySortKey:null,c==null?void 0:c.messageId,e,f,{editMsgHistory:!1,media:!1,reactions:!1,xma:!1}));return a.msgs});return u.apply(this,arguments)}function v(a,b,c,d,e){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g){c=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,c,"MAWFetchMessagesFromBackend"));var h=c.chatId;c=c.chatJid;var j=e==null?null:d("MAWDbMsg").toMsgId(e.messageId);j=(yield j==null?(i||(i=b("Promise"))).resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:j}));j=(j=j==null?void 0:j.externalId)!=null?j:e==null?void 0:e.offlineThreadingId;a=(yield r.requestMessages(a,h,c,e!=null?e.primarySortKey:null,j,f,g,{editMsgHistory:!0,media:!1,reactions:!1,xma:!1}));return a==null?void 0:a.msgs});return w.apply(this,arguments)}function x(a,b){if(a.sortOrderMs===b.sortOrderMs){var c;return((c=a.externalId)!=null?c:"").localeCompare((c=b.externalId)!=null?c:"")}return b.sortOrderMs-a.sortOrderMs}function y(a){return{externalId:a.offlineThreadingId,msgType:(h||(h=d("I64"))).to_string(a.displayedContentTypes),sortOrderMs:h.to_float(a.primarySortKey)}}function z(a){return babelHelpers["extends"]({},a)}function A(a){var c=function(a){var c=d("MAWDbMsg").toMsgId(a.messageId);return c==null?(i||(i=b("Promise"))).resolve(a):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:c}).then(function(b){return babelHelpers["extends"]({},a,{offlineThreadingId:(b=b==null?void 0:b.externalId)!=null?b:a.offlineThreadingId})})};return(i||(i=b("Promise"))).all(a.map(c))}function B(a,b){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.messages_ranges_v2__generated).getKeyRange(c)));if(a.length===0)return(i||(i=b("Promise"))).resolve("Messages range is missing");var e=function(a){a=d("MAWDbMsg").toMsgId(a);return a==null?(i||(i=b("Promise"))).resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:a}).then(function(a){return a==null?void 0:a.externalId})};c=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield (i||(i=b("Promise"))).all([e(a.maxMessageId),e(a.minMessageId)])),d=c[0];c=c[1];return babelHelpers["extends"]({},a,{maxMessageId:(d=d)!=null?d:a.maxMessageId,minMessageId:(d=c)!=null?d:a.minMessageId})});return function(b){return a.apply(this,arguments)}}();a=(yield (i||(i=b("Promise"))).all(a.map(c)));return i.resolve(JSON.stringify(a.map(function(a){return{hasMoreAfter:a.hasMoreAfter,hasMoreBefore:a.hasMoreBefore,maxMessageId:a.maxMessageId,maxTimestampMs:(h||(h=d("I64"))).to_string(a.maxTimestampMs),minMessageId:a.minMessageId,minTimestampMs:h.to_string(a.minTimestampMs)}})))});return C.apply(this,arguments)}function a(a,e,f,g,q,r,u,w){p.LOG(n(),(h||(h=d("I64"))).to_float(e),r==null?"null":(h||(h=d("I64"))).to_float(r.primarySortKey),q);var C=c("gkx")("1626");c("promiseDone")((i||(i=b("Promise"))).all([A(u),t(a,e,r,"before",q),v(a,e,r,"before",q),C?B(a,e):(i||(i=b("Promise"))).resolve(null)]),function(a){var b=a[0],i=a[1],n=a[2];a=a[3];if(n==null){p.LOG(m(),(h||(h=d("I64"))).to_float(e),r==null?"null":(h||(h=d("I64"))).to_float(r.primarySortKey));return}i=i.map(function(a){return z(a)}).sort(x).slice(0,q);n=n.map(function(a){return z(a)}).sort(x).slice(0,q);b=b.map(function(a){return y(a)}).sort(x);var t=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(b,i,q);b=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(b,n,q);i=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(i,n,q);p.LOG(l(),(h||(h=d("I64"))).to_float(e),r==null?"null":(h||(h=d("I64"))).to_float(r.primarySortKey),JSON.stringify(t));p.LOG(k(),h.to_float(e),r==null?"null":(h||(h=d("I64"))).to_float(r.primarySortKey),JSON.stringify(b));b.result!=="consistent"&&p.WARN(j(),(h||(h=d("I64"))).to_float(e),b.result,b.numOfMissingMessages);n=D(i);i=D(b);b=D(t);t=c("qex")._("1509");t=t==null?"null":t?"true":"false";s({threadKey:e,threadType:f},"message_integrity_check",g,{MAW_vs_EB_detailedResults:n.detailedResults,MAW_vs_EB_numOfMissingInReference:n.numOfMissingInReference,MAW_vs_EB_numOfMissingInTarget:n.numOfMissingInTarget,UI_vs_EB_detailedResults:i.detailedResults,UI_vs_EB_numOfMissingInReference:i.numOfMissingInReference,UI_vs_EB_numOfMissingInTarget:i.numOfMissingInTarget,UI_vs_MAW_detailedResults:b.detailedResults,UI_vs_MAW_numOfMissingInReference:b.numOfMissingInReference,UI_vs_MAW_numOfMissingInTarget:b.numOfMissingInTarget,hasAdditionalData:C?"true":"false",isAgnosticDataSourceOnOldMessageList:c("gkx")("2124")?"true":"false",isEBFetchesOnLoadMore:c("gkx")("1560")?"1":"0",isNewestOldestMsgCacheBypassedOnReadsV2:t,messagesRanges:(n=a)!=null?n:"null",pageIndex:w+"",pageSize:q+"",version:o})})}function D(a){var b=a.detailedResults.filter(function(a){a[0];a=a[1];return a==="missing_in_target"}).length,c=a.detailedResults.filter(function(a){a[0];a=a[1];return a==="missing_in_reference"}).length;return{detailedResults:E(a.detailedResults),numOfMissingInReference:c+"",numOfMissingInTarget:b+""}}function E(a){a=a.map(function(a){var b=a[0];a=a[1];return babelHelpers["extends"]({externalId:b.externalId},c("gkx")("1626")?{msgType:b.msgType,sortOrderMs:b.sortOrderMs}:{},{result:a})});return JSON.stringify(a)}e={runMessageIntegrityCheck:a};g["default"]=e}),98);